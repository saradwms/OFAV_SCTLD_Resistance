---
title: "OFAV SCTLD Resistance"
output: html_notebook
---

```{r}
# Load libraries needed
library(R2OpenBUGS)
library(ggplot2)
library(MASS)
library(scales)
library(patchwork)
library(FD)         # gower dissimiliarity matrix and some other 
#clustering stuff
library(ggplot2)    # plotting
library(vegan)      # stats
library(tidyverse)  # data manipulation
#cluster numbers
library(mclust)     # normal mixture modeling for model based clustering,
#customize denddrogram
library(dendextend) 
library(ggdendro)
#stats
library(FSA)
```
# Figure 1 stats & visualization

## Experiment Relative Risk

```{r}
all.exps<-read.csv("CombinedExperimentsIndividuals_V032024.csv",row.names = 1)

table(all.exps$Experiment, all.exps$Result)

```


```{r}

#number of experiments
k<-4
#values go in genotype order
#total number of experimental corals with disease
h<-c(58,84,91,62)
#total number of experimental corals 
r<-c(19+58,12+84,9+91,11+62)
#the total number of control corals with disease
l<-c(0,0,0,0)
#total number of control corals 
m<-c(77,96,100,73)


params<- list(k=k,h=h,r=r,l=l,m=m)

# Initial values
inits <- function() {
  list(nu=1, alpha=1)}

# Load model

RBayes <- bugs(params, inits, model.file= "BinomLikelihood_UnifromBeta.txt",
                parameters = c("RRISK"),
                n.chains = 1, DIC=TRUE, n.iter = 3000, debug=FALSE)
# Model output
RBayes
```

```{r}
### Extract the relative risk info needed for a catterpillar plot
rrdata<-as.data.frame(RBayes$summary)[-nrow(RBayes$summary),]
rrdata$RRmed<-RBayes$median$RRISK
Experiments<-c("Experiment 1","Experiment 2","Experiment 3","Experiment 4")

```

```{r}
ExpRR<-ggplot(rrdata,aes(x=RRmed,y=Experiments))+
  geom_point()+
  geom_linerange(aes(xmax=rrdata$`97.5%`, xmin=rrdata$`2.5%`),col="black")+
  geom_vline(xintercept=1,lwd=0.7)+
  scale_x_log10(breaks=trans_breaks("log10",function(x) 10^x),labels = trans_format("log10", math_format(10^.x)))+
  theme_bw()+annotation_logticks(sides="b")+labs(y="",x="Median Relative Risk",size=12)+theme(axis.text.y = element_text(size=12))
ExpRR
```

## Experiment Health Status by Day

```{r}
exp1<-read.csv("Exp1_statusV032024.csv")
head(exp1)
exp2<-read.csv("Exp2_statusV032024.csv")
head(exp2)
exp3<-read.csv("Exp3_statusV032024.csv")
head(exp3)
exp4<-read.csv("Exp4_statusV032024.csv")
head(exp4)
```

Get the data into long format and get the timepoints into the right format for plotting via ggplot.
```{r}
#move to a long format so that every row is now an observation of a colony at a single timepoint
e1_long <- gather(exp1, key=timept, value=state, Day.0:Day.14,factor_key = TRUE)
head(e1_long)
#make the health states factors
summary(e1_long)
e1_long$state<-factor(e1_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e2_long <- gather(exp2, key=timept, value=state, Day.0:Day.11,factor_key = TRUE)
head(e2_long)
#make the health states factors
e2_long$state<-factor(e2_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e3_long <- gather(exp3, key=timept, value=state, Day.0:Day.16,factor_key = TRUE)

#make the health states factors
e3_long$state<-factor(e3_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

head(e3_long)
levels(e3_long$state)

#move to a long format so that every row is now an observation of a colony at a single timepoint
e4_long <- gather(exp4, key=timept, value=state, Day.0:Day.18,factor_key = TRUE)
head(e4_long)
#make the health states factors
e4_long$state<-factor(e4_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))
unique(e4_long$state)
```

```{r}
anyNA(e1_long$state)
levels(e1_long$timept)<-sub('.',' ',levels(e1_long$timept),fixed=T)
e1graph<-ggplot(data=e1_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))+
  labs(y="Number of Fragments",x="Days Exposed")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="firebrick","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=10))+
  ylim(0,100)+
  ggtitle("Experiment 1: 1/14/22 - 1/28/22 ")
e1graph
```
```{r}
anyNA(e2_long$state)
levels(e2_long$timept)<-sub('.',' ',levels(e2_long$timept),fixed=T)
e2graph<-ggplot(data=e2_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "bottom")+
 theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))+
  labs(y="Number of Fragments",x="Days Exposed")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="firebrick","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=10))+
  ylim(0,100)+
  ggtitle("Experiment 2: 2/12/22 - 2/23/22")
e2graph
```

```{r}
anyNA(e3_long$state)
levels(e3_long$timept)<-sub('.',' ',levels(e3_long$timept),fixed=T)
e3graph<-ggplot(data=e3_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))+
  labs(y="Number of Fragments",x="Days Exposed")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="firebrick","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=10))+
  ylim(0,100)+
  ggtitle("Experiment 3: 3/11/22 - 3/27/22")
e3graph
```

```{r}
anyNA(e4_long$state)
levels(e4_long$timept)<-sub('.',' ',levels(e4_long$timept),fixed=T)
e4graph<-ggplot(data=e4_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))+
  labs(y="Number of Fragments",x="Days Exposed")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="firebrick","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=10))+
  ylim(0,100)+
  ggtitle("Experiment 4: 3/31/22 - 4/18/22")
e4graph
```

```{r,fig.width=8,fig.height=6}
timeseries<-(e1graph+e2graph+e3graph+e4graph)+plot_annotation(tag_levels="a")+plot_layout(guides = 'collect') & theme(legend.position = 'bottom',plot.tag=element_text(face="bold"))
timeseries
```
```{r}
pic<-png::readPNG("Diseasedpic.png",native=TRUE)

```

## Figure 1

```{r,fig.height=8,fig.width=8}
((wrap_elements(full=grid::rasterGrob(pic))+ExpRR)/timeseries)+plot_layout(heights=c(1,2))+plot_annotation(tag_levels='a')& theme(plot.tag=element_text(face="bold"))
ggsave("Figure1.png",dpi=300)
```

# Disease Phenotype Metrics


Summarize all individual results by DEP.Genotype
```{r}
alldf<-all.exps

#first need a binary result: 1 diseased/removed at end, 0 if healthy
for (i in 1:nrow(alldf)){
  if(alldf$Result[i]=="Healthy"){
    alldf$ResultBinary[i]<-0
  }else(alldf$ResultBinary[i]<-1)
}

alldf$ResultBinary<-as.numeric(alldf$ResultBinary)
numremoveddf<-aggregate(ResultBinary~DEP.Genotype,data=alldf,FUN=sum)
numexposeddf<-aggregate(Result~DEP.Genotype,data=alldf,FUN=length)

DEPsummary<-cbind(numexposeddf,numremoveddf$ResultBinary)
colnames(DEPsummary)<-c("DEP.Genotype","Num.Exposed","Num.Removed")
DEPsummary$Num.healthy<-DEPsummary$Num.Exposed-DEPsummary$Num.Removed
summary(DEPsummary)
resdf<-right_join(DEPsummary,alldf,by=c("DEP.Genotype"="DEP.Genotype"))
resdf[resdf$Result=="Diseased",]$Result<-"Removed"
```
Length of experiments:
exp1 = 14days
exp2 = 11days
exp3 = 16days
exp4 = 18days

```{r}

head(resdf)
resdf$DEP.Genotype<-as.factor(resdf$DEP.Genotype)

resdf$Result<-as.factor(resdf$Result)
resdf$Experiment<-as.factor(resdf$Experiment)
#add in the number days per experiment
explengths<-c(14,11,16,18)
exps<-levels(resdf$Experiment)
expdf<-data.frame(exps,explengths)
resdf$ExpLength<-expdf[match(resdf$Experiment,expdf$exps),]$explengths

#standardize the days to disease by experiment length: how much of the experiment length was the coral healthy --> 0 diseased immediately to 1 never diseased --> measure of same thing as DaysToDisease.std but now 1 is resistant
resdf$FracExpHealthy<-resdf$Daystodisease/resdf$ExpLength 
resdf$FracExpHealthy<-replace_na(resdf$FracExpHealthy,1)

#standardize the days spent diseased by experiment length --> 0 is highly susceptible to 1 is resistant
resdf$DaysDiseased.std<-resdf$Daysdiseased/resdf$ExpLength
max(resdf$DaysDiseased.std,na.rm=T)
resdf$DaysDiseased.std<-replace_na(resdf$DaysDiseased.std,1)

```

Standardize so that 1 is susceptible and 0 is resistant
```{r}
resdf$Transmission<-1-resdf$FracExpHealthy
resdf$Progression<-1-resdf$DaysDiseased.std
colnames(resdf)
```

Quick look at distributions by experiment
```{r}
ggplot(resdf, aes(x=Progression,color=Experiment,fill=Experiment))+
  geom_density(alpha=0.2)+
  theme_classic()+
  scale_color_manual(values=c("turquoise4","slateblue","springgreen4","steelblue4"))+
  scale_fill_manual(values=c("turquoise4","slateblue","springgreen4","steelblue4"))+
  theme(legend.position="bottom")+theme(strip.background = element_blank())+ggtitle("Progression")

ggplot(resdf, aes(x=Transmission,color=Experiment,fill=Experiment))+
  geom_density(alpha=0.2)+
  theme_classic()+
  scale_color_manual(values=c("violet","purple","darkblue","turquoise4"))+
  scale_fill_manual(values=c("violet","purple","darkblue","turquoise4"))+
  theme(legend.position="bottom")+theme(strip.background = element_blank())+ggtitle("Transmission")

ggplot(resdf, aes(x=Transmission,color=Experiment,fill=Experiment))+
  geom_histogram(position="dodge",alpha=0.2)+
  theme_bw()+
  scale_color_manual(values=c("violet","purple","darkblue","turquoise4"))+
  scale_fill_manual(values=c("violet","purple","darkblue","turquoise4"))+
  theme(legend.position="bottom")+theme(strip.background = element_blank())+ggtitle("Transmission")
```

```{r}
t.plot<-ggplot(resdf, aes(x=Experiment,y=Transmission))+
  geom_boxplot()+
  geom_point(aes(col=Experiment),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.2)+
  scale_color_manual(values=c("grey60","grey60","grey60","grey60"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  labs(y="Transmission",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
t.plot

p.plot<-ggplot(resdf, aes(x=Experiment,y=Progression))+
  geom_boxplot()+
  geom_point(aes(col=Experiment),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.2)+
  scale_color_manual(values=c("grey60","grey60","grey60","grey60"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  labs(y="Progression",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
p.plot

s.plot<-ggplot(resdf,aes(x=Experiment,fill=Result))+
  geom_bar(position="stack",stat="count")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Removed"="#003041"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,100),breaks=seq(0,100,10))+
  labs(y="Number of Fragments",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
s.plot


```


### Figure S1

```{r}
t1.plot<-ggplot(resdf, aes(x=Experiment,y=Daystodisease))+
  geom_boxplot()+
  geom_point(aes(col=Experiment),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.2)+
  scale_color_manual(values=c("grey60","grey60","grey60","grey60"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,16),breaks=seq(0,16,2))+
  labs(y="Days until disease signs",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
t1.plot

p1.plot<-ggplot(resdf, aes(x=Experiment,y=Daysdiseased))+
  geom_boxplot()+
  geom_point(aes(col=Experiment),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.2)+
  scale_color_manual(values=c("grey60","grey60","grey60","grey60"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,18),breaks=seq(0,18,2))+
  labs(y="Days with disease signs before removal",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
p1.plot

s.plot<-ggplot(resdf,aes(x=Experiment,fill=Result))+
  geom_bar(position="stack",stat="count")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Removed"="#003041"))+
  theme_bw()+
  theme(legend.position="none")+theme(strip.background = element_blank())+
  scale_y_continuous(limits=c(0,100),breaks=seq(0,100,10))+
  labs(y="Number of Fragments",x="")+theme(axis.text.x=element_text(angle=45,hjust=1))
s.plot

s.plot+t1.plot+p1.plot
ggsave("FigureS1.png",dpi=300)
```


```{r}
sustable<-table(resdf$Result,resdf$Experiment)
sustable

print("mean & SE of survivors per experiment")
mean(c(19,12,9,11))
sd(c(19,12,9,11))/sqrt(4)

print("mean & SE of days to disease per experiment")
mean(aggregate(Daystodisease~Experiment,data=resdf,FUN = mean)[,2])
sd(aggregate(Daystodisease~Experiment,data=resdf,FUN = mean)[,2])/2

print("mean & SE of days with disease per experiment")
mean(aggregate(Daysdiseased~Experiment,data=resdf,FUN = mean)[,2])
sd(aggregate(Daysdiseased~Experiment,data=resdf,FUN = mean)[,2])/2
```

# Risk by Donor fragment exposure


```{r}
head(resdf)
dondf<-as.data.frame.matrix(table(resdf$Donor.Frag,resdf$Result))
dondf<-rownames_to_column(dondf)
controls<-read.csv("ControlCorals.csv")
table(controls$Donor.Frag)
dondf[13,]<-c("A",84,0)
dondf[14,]<-c("B",68,0)
dondf[15,]<-c("C",117,0)
dondf$Healthy<-as.numeric(dondf$Healthy)
dondf$Removed<-as.numeric(dondf$Removed)
dondf$exposed<-dondf$Healthy+dondf$Removed
# Ratio of the average # of observed diseases to total population, e.g. sum all cases of WBD across regions and divide by the sum of all acropora across regions
r<-sum(dondf$Removed)/sum(dondf$exposed)

# Calculate average expected # diseased corals for each region by multiplying the r value calculated above for the population by the number of acropora in that region
dondf$Expected<-dondf$exposed *r 

###################################################################
# Poisson-gamma relative risk model
# Bayesian analysis using the Poisson_Gamma_RR_Model.txt file
# White band disease on Acropora
###################################################################

# Data needed for the model
#number of observations (regions)
N<-nrow(dondf) 
#list of parameters
d<-list(N=N, observed=dondf$Removed, expected=dondf$Expected)

# Initial values (used to constrain the gamma distribution in the model)
inits <- function() {
  list(nu=1, alpha=1)}

# Load model

RBayes <- bugs(d, inits, model.file= "Poisson_Gamma_RR_Model.txt",
                parameters = c("theta", "nu", "alpha"),
                n.chains = 1, DIC=TRUE, n.iter = 3000, debug=FALSE)
# Model output
RBayes
plot(RBayes)
```
```{r}
### Extract the relative risk info needed for a catterpillar plot
rrdata<-as.data.frame(RBayes$summary)[1:15,]
rrdata$RRmed<-RBayes$median$theta
rrdata$Donor<-dondf$rowname
histores<-read.csv("Histology Results.csv")
histoRR<-merge(histores,rrdata,by="Donor")
```

```{r}
donorrisk<-ggplot(histoRR,aes(x=RRmed,y=Name,col=HistoRes))+
  geom_point(size=3)+
  geom_linerange(aes(xmax=histoRR$`97.5%`, xmin=histoRR$`2.5%`,color=HistoRes),lwd=1)+
  geom_vline(xintercept=1,lwd=.5)+
  scale_x_log10(breaks=trans_breaks("log10",function(x) 10^x),labels = trans_format("log10", math_format(10^.x)))+
  theme_bw()+annotation_logticks(sides="b")+labs(y="Donor Fragment",x="Median Relative Risk",col="Histology Result")+
    scale_color_manual(values=c("Healthy"="#00aae7","Diseased"="#003041"))+
    theme(legend.position='none')+theme(axis.text.y = element_text(size=12),axis.text = element_text(size=12))
donorrisk
```

Donor progression rate
```{r}
DonTL<-read.csv("DonorTL.csv")
DonTL$Donor<-DonTL$Main.frag
DonTL$Donor %in% histores$Donor
DonTL[14,]
tldf<-merge(DonTL,histores,by="Donor")
df<-aggregate(AvgTLperday~HistoRes,data=tldf,FUN=mean)
df$se<-aggregate(AvgTLperday~HistoRes,data=tldf,FUN=function(x) sd(x)/sqrt(length(x)))$AvgTLperday
df
donortl<-ggplot(df,aes(x=HistoRes,y=AvgTLperday,fill=HistoRes))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymax=AvgTLperday + se, ymin=AvgTLperday-se),width=0.2,lwd=0.7)+
  scale_fill_manual(values=c("Healthy"="#00aae7","Diseased"="#003041"))+
  scale_y_continuous(breaks=seq(0,2.5,0.25),expand = c(0, 0),lim=c(0,2.5))+
  labs(x="Histology Result",y=bquote("Average Tissue Loss" (cm^2/Day)))+
  theme(legend.position = "none",legend.text=element_text(size=12),legend.title=element_blank()) + 
  theme(panel.background = element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"))
donortl
```

```{r,fig.width=6,fig.height=6}
donorrisk/donortl
ggsave("FigureS3.png",dpi=300)
```

Was progression sig diff between diseased donor colonies that were histology-determined to be "diseased" or "healthy"? (no)
```{r}

#Visual: qqplot = use to determine whether the data is normally distributed by comparing its quantiles (y-axis) to those of a normal distribution (x axis). Want the points to line up well with the red line
qqnorm(tldf$AvgTLperday)
qqline(tldf$AvgTLperday,col="red")

#formal test: shapiro-wilk test, if p<0.05, then data does not come from a normal distribution
shapiro.test(sqrt(tldf$AvgTLperday)) #sqrt transform works
dishist<-subset(tldf,subset=histores=="Diseased")
healthyhist<-subset(tldf,subset=histores=="Healthy")
t.test(sqrt(dishist$AvgTLperday),sqrt(healthyhist$AvgTLperday))
```


## aggregate disease phenotypes by WGS genoytpe
```{r}
levels(resdf$Result)

GenoDF<-(as.data.frame.matrix(table(resdf$DEP.Genotype,resdf$Result)))
GenoDF$Exposed<-GenoDF$Healthy+GenoDF$Removed
GenoDF
GenoDF$DEP.Genotype<-as.factor(rownames(GenoDF))

daysdis<-aggregate(DaysDiseased.std~DEP.Genotype,data=resdf,FUN=mean,na.rm=TRUE)
FracExpHealthy<-aggregate(FracExpHealthy~DEP.Genotype,data=resdf,FUN=mean,na.rm=TRUE)

GenoDF$avgDaysDiseased.std<-daysdis$DaysDiseased.std
GenoDF$avgFracExpHealthy<-FracExpHealthy$FracExpHealthy
GenoDF$FracDiseased<-GenoDF$Removed/GenoDF$Exposed
GenoDF$FracHealthy<-GenoDF$Healthy/GenoDF$Exposed

GenoDF
#write.csv(GenoDF,"RiskbyDEPGenotype_V032024.csv")

```


# Hierarchical Clustering Analysis to determine resistance groups
```{r}
GenoDF<-read.csv("RiskbyDEPGenotype_V032024.csv",row.names = 1)
head(GenoDF)
```
avgDaysDiseased.std: days with disease signs divided by experiment length; 0 is fast progression (small fraction of experiment time spent with disease) and 1 is resistant (spent all experiment without disease)

avgFracExpHealthy: days before disease signs divided by experiment length; 0 is diseased immediately and 1 is never diseased
FracDiseased: fraction of replicates diseased
FracHealthy: fraction of replicates healthy

Progression = 1- avgDaysDiseased.std --> 1 is fast progression (), 0 is resistant
Transmission = 1 - avgFracExpHealthy --> 1 is diseased immediately, 0 is never diseased
Susceptibilty = fraction of corals diseased


Cluster using progression, transmission, frac diseased

```{r}
GenoDF$Transmission<-1-GenoDF$avgFracExpHealthy
GenoDF$Progression<-1-GenoDF$avgDaysDiseased.std

print("mean & SD of transmission")
mean(GenoDF$Transmission)
sd(GenoDF$Transmission)
print("mean & SD of progression")
mean(GenoDF$Progression)
sd(GenoDF$Progression)
print("mean & SD of susceptibility")
mean(GenoDF$FracDiseased)
sd(GenoDF$FracDiseased)
```

## All exposed
```{r,fig.width=10,fig.height=4}

data_gdisall<-gowdis(GenoDF[,c(7,9,10)])
hc_gowdisall <- hclust(data_gdisall, method = "ward.D2" )
dendall <- as.dendrogram(hc_gowdisall)
dendall

par(cex=0.4, mar=c(10, 5, 5, 2))
plot(dendall, xlab="", ylab="", main="", sub="", axes=FALSE)
par(cex=.7)
title(xlab="Genotypes", ylab="Clustering Height")
axis(2)

dall<-dendro_data(dendall,type="rectangle")
groupsall<-cutree(hc_gowdisall,5)
GenoDF$sus.groups<-as.factor(groupsall)
GenoDF[order(GenoDF[,9],decreasing=T),]
labs<-right_join(dall$labels,GenoDF,by=c("label"="DEP.Genotype"))

alldendplot<-ggplot(dall$segments) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend))+
  geom_text(data = dall$labels, aes(x, y, label = label,color=labs$sus.groups),
            hjust = 1.2, angle = 90, size = 2)+
  geom_point(data = dall$labels, aes(x, y,color=labs$sus.groups),size=.5)+
  scale_y_continuous(limits=c(-1,4.5),breaks=seq(0,4.5,0.5))+
  theme_bw()+
  scale_color_manual(values=c("orange1","red3","springgreen4","steelblue3","palegreen2"))+
  theme(legend.position = "none")+labs(color="Cluster",y="Clustering Height",x="")+
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())+guides(color=guide_legend(override.aes = list(size=5)))

alldendplot
#ggsave("justdendro_all5clusters.png",dpi=300)
```

1 is susceptbile, 2 is highly susceptible, 3 is resistant, 4 is intermediate, 5 is 1/1 resistant
```{r}
GenoDF$sus<-GenoDF$sus.groups
levels(GenoDF$sus)<-c("Susceptible","Highly Susceptible","Resistant","Intermediate","1/1 Resistant")
GenoDF$sus<-factor(GenoDF$sus,c("Highly Susceptible","Susceptible","Intermediate","Resistant","1/1 Resistant"))
```


```{r,fig.width=9,fig.height=3}
p1<-ggplot(GenoDF,aes(x=sus,y=Progression,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Progression")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","a","b","b","b"),x=c(1:5),y=c(0.05,0.05,0.05,0.05,0.1))
p1
p2<-ggplot(GenoDF,aes(x=sus,y=Transmission,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
   theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Transmission")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","b","bc","bc","c"),x=c(1:5),y=c(0.05,0.05,0.05,0.05,0.1))
p3<-ggplot(GenoDF,aes(x=sus,y=FracDiseased,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
   theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Susceptibility")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","a","b","b","b"),x=c(1:5),y=c(0.05,0.05,0.05,0.05,0.1))

p3+p2+p1
#ggsave("susmetrics_all5clusters.png",dpi=300)
```

```{r,fig.width=10,fig.height=6}
alldendplot/(p3+p2+p1)+plot_annotation(tag_levels = "a")
ggsave("FigureS5.png",dpi=300)
```

```{r}

mod<-aov(log(FracDiseased+1)~sus,data=GenoDF)
shapiro.test(mod$residuals)
kruskal.test(FracDiseased~sus, data=GenoDF)
allgenos.dunn<-dunnTest(FracDiseased~sus,GenoDF,"bonferroni")
subset(allgenos.dunn$res,subset=P.adj>0.05)

```
HS=a
S = a
I = b
R = b
1/1 R = b


```{r}
mod<-aov((Progression)~sus,data=GenoDF)
shapiro.test(mod$residuals)
kruskal.test(Progression~sus, data=GenoDF)
allgenos.dunn<-dunnTest(Progression~sus,GenoDF,"bonferroni")
subset(allgenos.dunn$res,subset=P.adj>0.05)

```
HS=a
S = a
I = b
R = b
1/1 R = b

```{r}
mod<-aov((Transmission)~sus,data=GenoDF)
shapiro.test(mod$residuals)
kruskal.test(Transmission~sus, data=GenoDF)
allgenos.dunn<-dunnTest(Transmission~sus,GenoDF,"bonferroni")
subset(allgenos.dunn$res,subset=P.adj>0.05)

```
HS= a
S = b
I = bc
R = bc
1/1 R = c

## Now just the ones with 3 or more replicates
```{r}
GenoDFsub3<-subset(GenoDF,subset=Exposed>2)
colnames(GenoDFsub3)
```


```{r,fig.width=10,fig.height=4}

data_gdisall<-gowdis(GenoDFsub3[,c(7,9,10)])
hc_gowdisall <- hclust(data_gdisall, method = "ward.D2" )
dendall <- as.dendrogram(hc_gowdisall)
dendall

par(cex=0.4, mar=c(10, 5, 5, 2))
plot(dendall, xlab="", ylab="", main="", sub="", axes=FALSE)
par(cex=.7)
title(xlab="Genotypes", ylab="Clustering Height")
axis(2)

dall<-dendro_data(dendall,type="rectangle")
groupsall<-cutree(hc_gowdisall,4)
GenoDFsub3$sus.groups<-as.factor(groupsall)
GenoDFsub3[order(GenoDFsub3[,9],decreasing=T),]
labs<-right_join(dall$labels,GenoDFsub3,by=c("label"="DEP.Genotype"))

alldendplot<-ggplot(dall$segments) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend))+
  geom_text(data = dall$labels, aes(x, y, label = label,color=labs$sus.groups),
            hjust = 1.2, angle = 90, size = 3)+
  geom_point(data = dall$labels, aes(x, y,color=labs$sus.groups),size=.5)+
  scale_y_continuous(limits=c(-0.7,2.3),breaks=seq(0,2.3,0.5))+
  theme_bw()+
  scale_color_manual(values=c("red3","steelblue3","orange1","springgreen4","palegreen2"))+
  theme(legend.position = "none")+labs(color="Cluster",y="Clustering Height",x="")+
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),axis.title.y=element_text(size=12),axis.text.y=element_text(size=10))#+
  #guides(color=guide_legend(override.aes = list(size=5)))

alldendplot
#ggsave("justdendro_all5clusters.png",dpi=300)
```

1 is highly susceptbile, 2 is intermediate, 3 issusceptible, 4 is resistant
```{r}
GenoDFsub3$sus<-GenoDFsub3$sus.groups
levels(GenoDFsub3$sus)<-c("Highly Susceptible","Intermediate","Susceptible","Resistant")
GenoDFsub3$sus<-factor(GenoDFsub3$sus,c("Highly Susceptible","Susceptible","Intermediate","Resistant"))
```

```{r,fig.width=9,fig.height=3}
p1<-ggplot(GenoDFsub3,aes(x=sus,y=Progression,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Progression")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","ab","b","b"),x=c(1:4),y=c(0.05,0.05,0.05,0.05))
p1
p2<-ggplot(GenoDFsub3,aes(x=sus,y=Transmission,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
   theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Transmission")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","b","b","c"),x=c(1:4),y=c(0.05,0.05,0.05,0.05))
p3<-ggplot(GenoDFsub3,aes(x=sus,y=FracDiseased,fill=sus,alpha=1))+
  geom_boxplot()+
  geom_point(aes(color=sus),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"))+
   theme_bw()+
  theme(legend.position = 'none')+labs(x="",y="Susceptibility")+theme(axis.text.x=element_text(angle=45,hjust=1))+
  scale_y_continuous(limits=c(0,1),breaks=seq(0,1,0.1))+
  annotate("text",label=c("a","ab","b","b"),x=c(1:4),y=c(0.05,0.05,0.05,0.05))


p3+p2+p1
#ggsave("susmetrics_all5clusters.png",dpi=300)
```



```{r,fig.width=10,fig.height=7}
alldendplot/(p3+p2+p1)+plot_annotation(tag_levels = "a")& theme(plot.tag=element_text(face="bold"))
ggsave("Figure3.png",dpi=300)
```

```{r}
mod<-aov((Transmission)~sus,data=GenoDFsub3)
shapiro.test(mod$residuals)
anova(mod)
library(multcomp)
library(multcompView)
mod.tukey<-TukeyHSD(mod)
mod.tukey
labels <- multcompLetters(mod.tukey$`sus`[, "p adj"])$Letters

```
hs = a
s = b
i = b
r = c


```{r}
mod<-aov((Progression)~sus,data=GenoDFsub3)
shapiro.test(mod$residuals)
kruskal.test(Progression~sus, data=GenoDFsub3)
allgenos.dunn<-dunnTest(Transmission~sus,GenoDFsub3,"bonferroni")
subset(allgenos.dunn$res,subset=P.adj>0.05)

```
HS = a
S = ab
I = b
R = b

```{r}

mod<-aov((FracDiseased)~sus,data=GenoDFsub3)
shapiro.test(mod$residuals)
kruskal.test(FracDiseased~sus, data=GenoDFsub3)
allgenos.dunn<-dunnTest(FracDiseased~sus,GenoDFsub3,"bonferroni")
subset(allgenos.dunn$res,subset=P.adj>0.05)

```
HS = a
S = ab
I = b
R= b

```{r}
aggregate(Progression~sus,data=GenoDFsub3,FUN=mean)
aggregate(Progression~sus,data=GenoDFsub3,FUN=function(x) sd(x)/sqrt(length(x)))
```

# Ouplant survival & relative risk

### Standardized mortality ratio for outplant data

```{r}
fielddf<-read.csv("FieldStudyWGS.csv")
sum(fielddf$Number.Outplanted)
# Ratio of the average # of observed diseases to total population, e.g. sum all cases of WBD across regions and divide by the sum of all acropora across regions
r<-sum(fielddf$Diseased.Fragment.Count)/sum(fielddf$Number.Outplanted)

# Calculate average expected # diseased corals for each region by multiplying the r value calculated above for the population by the number of acropora in that region
fielddf$Expected<-fielddf$Number.Outplanted *r 

###################################################################
# Poisson-gamma relative risk model
# Bayesian analysis using the Poisson_Gamma_RR_Model.txt file
# White band disease on Acropora
###################################################################

# Data needed for the model
#number of observations (regions)
N<-nrow(fielddf) 
#list of parameters
d<-list(N=N, observed=fielddf$Diseased.Fragment.Count, expected=fielddf$Expected)

# Initial values (used to constrain the gamma distribution in the model)
inits <- function() {
  list(nu=1, alpha=1)}

# Load model

RBayes <- bugs(d, inits, model.file= "Poisson_Gamma_RR_Model.txt",
                parameters = c("theta", "nu", "alpha"),
                n.chains = 1, DIC=TRUE, n.iter = 3000, debug=FALSE)
# Model output
RBayes
plot(RBayes)
```

```{r}
### Extract the relative risk info needed for a catterpillar plot
rrdata<-as.data.frame(RBayes$summary)[1:8,]
rrdata$RRmed<-RBayes$median$theta
rrdata$Genotypes<-fielddf$New.Geno.Name
rrdata$DEPgenos<-fielddf$DEP.Genotype
rrdata$Susgroup<-fielddf$Rgroup
rrdata$Susgroup<-factor(rrdata$Susgroup,c("Highly Susceptible","Intermediate","1/1 Resistant"))
rrdata$Names<-fielddf$ComboGeno
```

```{r}
outplantrisk<-ggplot(rrdata,aes(x=RRmed,y=reorder(DEPgenos,-RRmed),col=Susgroup))+
  geom_point(size=3)+
  geom_linerange(aes(xmax=rrdata$`97.5%`, xmin=rrdata$`2.5%`,col=Susgroup),lwd=1)+
  geom_vline(xintercept=1,lwd=.5)+
  scale_x_log10(breaks=trans_breaks("log10",function(x) 10^x),labels = trans_format("log10", math_format(10^.x)))+
  theme_bw()+annotation_logticks(sides="b")+labs(y=" ",x="Median Relative Risk",col="")+scale_color_manual(values=c("red3","steelblue","palegreen2"))+theme(legend.position='none')+theme(axis.text.y = element_text(size=12),axis.text = element_text(size=12))
outplantrisk
#ggsave("OutplantRR.png",dpi=300)
```
### Outplant Survival
So the sctld outplant study was conducted in 2018 at Site N, Cook Island, Munson Reef, KW Midchannel, Eastern Dry Rocks, Higgs Heads

Offshore:
- N_M_1 (LK) Site N
- T_M_1 (KW) EDR
midchannel had highest disease prevalence (~20%)
- MH_M_1 (LK) Munson Reef
- KWM_M_1 (KW) KW Midchannel
nearshore sites had minimal disease activity (<1%)
- CI_M_2 (LK) Cook Island
- HH_M_1 (KW) Higgs Head
```{r}
ofav<-read.csv("JustOFAV_V031825.csv")
ofav$Outplant.Date<-as.Date(ofav$Outplant.Date,format="%m/%d/%Y")
ofav$Monitoring.Date<-as.Date(ofav$Monitoring.Date,format="%m/%d/%Y")
ofav$Geno<-as.factor(ofav$Geno)
summary(ofav)
levels(ofav$Geno)
```

```{r}
WGS<-read.csv("WGSresults_V032024.csv") #wgs results
head(WGS)
#add WGS ID
WGS$Multi.Locus.Genotype.ID<-paste("WGS-",WGS$Multi.Locus.Genotype.ID,sep="")
DEPmeta<-WGS
#DEPmeta<-subset(DEPmeta,subset=Known.Mote.geno=="Y")
#DEPmeta<-subset(DEPmeta,subset=Sample.Source=="Experiment")
DEPmeta$Geno.std<-as.factor(DEPmeta$Geno.std)

ofav1819<-subset(ofav,subset=Outplant.Date<="2020-01-01")
#ofav<-ofav1819
levels(ofav1819$Geno) %in% levels(DEPmeta$Geno.std)
meta<-DEPmeta[,c("Geno.std","Multi.Locus.Genotype.ID")]
meta<-distinct(meta)

ofav2<-subset(ofav,subset=Geno %in%meta$Geno.std)
ofav2<-ofav2[ofav2$Geno!="OF689",]
ofav2$Geno<-droplevels(ofav2$Geno)
levels(ofav2$Geno)
dim(ofav2)
```


```{r,fig.width=8}

ofav3<-merge(meta,ofav2,by.y="Geno",by.x="Geno.std")
levels(as.factor(ofav3$Site))
levels(as.factor(ofav3$Location))
#33 site IDs from 16 reefs
head(ofav3)
nrow(ofav3)
sum(ofav3$Num.Frags.Array) #3301 frags outplanted in 363 clusters
levels(as.factor(ofav3$Multi.Locus.Genotype.ID)) #24 WGS-genotypes included

GenoSus<-rownames_to_column(GenoDF)

OFAV1<-merge(ofav3,GenoSus,by.x="Multi.Locus.Genotype.ID",by.y="rowname")
OFAV1$Geno.name<-paste(OFAV1$Geno.std,OFAV1$Multi.Locus.Genotype.ID,sep="/")

OFAV1$Sus.group<-factor(OFAV1$sus,levels=c("Highly Susceptible","Susceptible", "Intermediate","Resistant","1/1 Resistant"))
colnames(OFAV1)
```

```{r}
ofdf<-OFAV1
ofdf$Perc.Survival<-((ofdf$Num.Frags.Array-(as.numeric(ofdf$Num.Dead.Old)+as.numeric(ofdf$Num.Dead.New)+as.numeric(ofdf$Num.Missing)))/ofdf$Num.Frags.Array)*100
ofdf<-ofdf[!is.na(ofdf$Perc.Survival),]
ofdf$Multi.Locus.Genotype.ID<-as.factor(ofdf$Multi.Locus.Genotype.ID)

```


```{r}
mean(ofdf$Perc.Survival)
sd(ofdf$Perc.Survival)/sqrt(length(ofdf$Perc.Survival))
outplantsurvival<-ggplot(ofdf,aes(x=Sus.group,y=Perc.Survival,col=Sus.group))+
  geom_boxplot()+
  geom_point(aes(color=Sus.group),position=position_jitterdodge(jitter.height=0,jitter.width=0.7),alpha=0.5)+
  scale_color_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"), drop = FALSE)+
  #scale_x_discrete(limits=levels(bills.spsex$sps))+
  scale_y_continuous(breaks=seq(0,100,10),expand = c(0, 0),lim=c(0,110))+theme_bw()+
  labs(x="",y="Outplant Percent Survival")+
  theme(legend.position ="none", legend.text=element_text(size=12), legend.title=element_blank()) + #extra to make it pretty
  #theme(panel.background = element_blank())+
  geom_hline(yintercept =mean(ofdf$Perc.Survival) )+
  geom_hline(yintercept =median(ofdf$Perc.Survival),linetype="dashed" )+
  #theme(text = element_text(family = "Times New Roman"))+
  theme(axis.text.x=element_text(angle=25,hjust=1))
 # facet_wrap(~Location,scales="free_x",nrow=2)
outplantsurvival
#ggsave("OutplantSurvival.png",dpi=300)
```

```{r,fig.width=9,fig.height=4}
ofmeans<-aggregate(Perc.Survival~Multi.Locus.Genotype.ID*Sus.group,data=ofdf,FUN=mean)
ofse<-aggregate(Perc.Survival~Multi.Locus.Genotype.ID*Sus.group,data=ofdf,FUN=function(x) sd(x)/sqrt(length(x)))
OFAV<-cbind(ofmeans,ofse$Perc.Survival)
colnames(OFAV)<-c("Geno","Sus.group","means","se")


ggplot(OFAV,aes(x=Geno,y=means,fill=Sus.group))+
  geom_bar(stat="identity",position=position_dodge(.9))+
  geom_errorbar(aes(ymax=means + se, ymin=means-se),width=0.2,position=position_dodge(.9))+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"), drop = FALSE)+
  #scale_x_discrete(limits=levels(bills.spsex$sps))+
  scale_y_continuous(breaks=seq(0,100,10),expand = c(0, 0),lim=c(0,110))+
  labs(x="",y="Outplant Survival 2018-2023")+
  theme(legend.position ="none", legend.text=element_text(size=12), legend.title=element_blank()) + #extra to make it pretty
  theme(panel.background = element_blank())+
  #theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_text(angle=45,hjust=1,size=8))+facet_grid(~Sus.group,scales="free_x")
ggsave("FigureS6.png",dpi=300)
```


```{r,fig.width=8,fig.height=4}
(free(outplantrisk,type="label")|outplantsurvival) +plot_annotation(tag_levels="a")& theme(plot.tag=element_text(face="bold"))
ggsave("Figure4.png",dpi=300)
```



