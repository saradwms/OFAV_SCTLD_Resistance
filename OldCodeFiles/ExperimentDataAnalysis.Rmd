---
title: "DEP Experiment Data Analysis"
output: html_notebook
---
Packages needed
```{r}
library(ggplot2)
library(tidyverse)
library(patchwork)
```
```{r}
exp1<-read.csv("Exp1_status.csv")
head(exp1)
exp2<-read.csv("Exp2_status.csv")
head(exp2)
exp3<-read.csv("Exp3_status.csv")
head(exp3)
exp4<-read.csv("Exp4_statusfixed.csv")
head(exp4)
```

Get the data into long format and get the timepoints into the right format for plotting via ggplot.
```{r}
#move to a long format so that every row is now an observation of a colony at a single timepoint
e1_long <- gather(exp1, key=timept, value=state, Day.0:Day.14,factor_key = TRUE)
head(e1_long)
#make the health states factors
summary(e1_long)
e1_long$state<-factor(e1_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e2_long <- gather(exp2, key=timept, value=state, Day.0:Day.11,factor_key = TRUE)
head(e2_long)
#make the health states factors
e2_long$state<-factor(e2_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e3_long <- gather(exp3, key=timept, value=state, Day.0:Day.16,factor_key = TRUE)

#make the health states factors
e3_long$state<-factor(e3_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

head(e3_long)
levels(e3_long$state)

#move to a long format so that every row is now an observation of a colony at a single timepoint
e4_long <- gather(exp4, key=timept, value=state, Day.0:Day.18,factor_key = TRUE)
head(e4_long)
#make the health states factors
e4_long$state<-factor(e4_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

```

```{r}
e1graph<-ggplot(data=e1_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_blank(),axis.title.y=element_text(size=14))+
  labs(y="Number of Genotypes")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="#ca581f","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=12))+
  ylim(0,100)+
  ggtitle("Experiment 1: 1/14 - 1/28 ")
e1graph
```
```{r}
e2graph<-ggplot(data=e2_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "bottom")+
  theme(axis.title.x=element_blank(),axis.title.y=element_text(size=14))+
  labs(y="")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="#ca581f","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=12))+
  ylim(0,100)+
  ggtitle("Experiment 2: 2/12 - 2/23")
e2graph
```

```{r}
e3graph<-ggplot(data=e3_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_blank(),axis.title.y=element_text(size=14))+
  labs(y="")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="#ca581f","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=12))+
  ylim(0,100)+
  ggtitle("Experiment 3: 3/11 - 3/27")
e3graph
```
```{r}
e4graph<-ggplot(data=e4_long,mapping=aes(x=timept,fill=state))+
  geom_bar(aes(fill=state))+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  theme(legend.position = "none")+
  theme(axis.title.x=element_blank(),axis.title.y=element_text(size=14))+
  labs(y="")+
  scale_fill_manual(values=c("Healthy"="#00aae7","Watch"="#ebcc00","Initial Disease"="#f26522","Diseased"="#ca581f","Removed"="#003041"), labels=c("Healthy","Watch","Initial Disease","Diseased","Removed"),drop=FALSE)+
  theme(axis.text.x = element_text(angle=70, hjust=1,size=12))+
  ylim(0,100)+
  ggtitle("Experiment 4: 3/31 - 4/18")
e4graph
```

```{r,fig.width=8,fig.height=6}
(e1graph+e2graph+e3graph+e4graph)+plot_layout(guides = 'collect') & theme(legend.position = 'bottom')
```
```{r}
e1_long$Experiment<-"Exp1"
e2_long$Experiment<-"Exp2"
e3_long$Experiment<-"Exp3"
e4_long$Experiment<-"Exp4"
allexplong<-rbind(e1_long,e2_long,e3_long,e4_long)
allexplong$Day<-allexplong$timept
write.csv(allexplong,"IndividualStates.csv")
```


```{r}
df<-exp2
new_inf_corals<-function(df,steps,x){
  ## newly_I
  newly_I<-matrix(NA, nrow = (nrow(df)), ncol = steps+1) #blank matrix for storing newly infected corals
  #newly_I
  for (i in 1:steps){ #for each survey time point
    col<-x+i #start with first tp after init tp
    prev<-x+i-1
    for (j in 1:(nrow(df))){ #for each row in the df
      #print (df[j,col])
      if ( df[j,col]=="Diseased" ){ #if it's diseased
        #print( "found one")
        if (df[j,prev]!="Diseased"){ # and if it wasnt diseased before
          newly_I[j,i]<-1 #add it to newly infected
        }
      }
    }
  }
  return(newly_I)
}


mat<-new_inf_corals(exp3,ncol(exp3)-7,7)
lastcall<-ncol(exp3)-7+1
mat[,lastcall]<-.5
df<-exp3
df$disday<-apply(mat,1,which.max)
#lastcall<-ncol(exp1)-7
for(i in 1:nrow(df)){
  if(df$disday[i]==lastcall){
    df$disday[i]<-NA
  }
}
  
exp.df<-exp2
daystodis<-function(exp.df){
  exp.copy<-exp.df
  exp.copy[exp.df=="Initial Disease"]<-"Diseased"
  lastcall<-ncol(exp.copy)-9+1
  wheninf<-new_inf_corals(exp.copy,ncol(exp.copy)-9,9)
  
  wheninf[,lastcall]<-.5
  exp.df$daystodis<-apply(wheninf,1,which.max)
  for(i in 1:nrow(exp.df)){
    if(exp.df$daystodis[i]==lastcall){
      exp.df$daystodis[i]<-NA
    }
  }
  return(exp.df)
}
daystodis(exp2)
```

```{r}

e1days<-cbind(daystodis(exp1)$daystodis,"Exp 1")
e2days<-cbind(daystodis(exp2)$daystodis,"Exp 2")
e3days<-cbind(daystodis(exp3)$daystodis,"Exp 3")
e4days<-cbind(daystodis(exp4)$daystodis,"Exp 4")
Mote2<-c("#00aae7", "#f37163" ,"#b1b3b3", "#63666a" ,"#000000")
daysinf<-rbind(e1days,e2days,e3days,e4days)
daysinf.df<-data.frame(daysinf)
daysinf.df$X1<-as.numeric(daysinf.df$X1)
colnames(daysinf.df)<-c("Days to Disease","Experiment")
mean(daysinf.df$`Days to Disease`)
initdisplot<-ggplot(daysinf.df,aes(Experiment,`Days to Disease`,color=Experiment))+
  geom_boxplot()+
  theme_bw()+
  theme(panel.grid.minor =element_blank())+
  scale_color_manual(values=Mote2)+
  theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))+
  scale_y_continuous(breaks=seq(0,15,1),expand = c(0, 0),lim=c(0,15))+
  labs(y="Days until disease signs",x="Experiment")+theme(legend.position = "none")

initdisplot
```

```{r,fig.width=7,fig.height=3}

dis_corals<-function(df,steps,x){
  ## newly_I
  dismat<-matrix(0, nrow = nrow(df), ncol = steps) #blank matrix for storing newly infected corals
  #newly_I
  for (i in 1:steps){ #for each survey time point
    col<-x+i #start with first tp after init tp
    prev<-x+i-1
    for (j in 1:(nrow(df))){ #for each row in the df
      #print (df[j,col])
      if ( df[j,col]=="Diseased" ){ #if it's diseased
        #print( "found one")
        dismat[j,i]<-1
      }
    }
  }
  
  return(dismat)
}
exp.df<-exp2

daysdis<-function(exp.df){
  exp.copy<-exp.df
  exp.copy[exp.df=="Initial Disease"]<-"Diseased"
  whendis<-dis_corals(exp.copy,ncol(exp.copy)-9,9)
  df<-data.frame(exp.df[,1:4],disdays=rowSums(whendis))
  for(i in 1:nrow(exp.copy)){
    if(exp.copy[i,ncol(exp.copy)]=="Healthy"){
      df$disdays[i]<-NA
    }
  }
  return(df)
}
daysdis(exp1)
daysdis(exp2)
daysdis(exp3)
daysdis(exp4)

e1ddays<-cbind(daysdis(exp1)$disdays,"Experiment 1")
e2ddays<-cbind(daysdis(exp2)$disdays,"Experiment 2")
e3ddays<-cbind(daysdis(exp3)$disdays,"Experiment 3")
e4ddays<-cbind(daysdis(exp4)$disdays,"Experiment 4")

daysinf<-rbind(e1ddays,e2ddays,e3ddays,e4ddays)
daysinf.df<-data.frame(daysinf)
daysinf.df$X1<-as.numeric(daysinf.df$X1)
colnames(daysinf.df)<-c("Days Diseased","Experiment")
mean(daysinf.df$`Days Diseased`)

daysdisplot<-ggplot(daysinf.df,aes(x=`Days Diseased`))+ geom_histogram(binwidth = 1,alpha=0.5,color="black",fill="grey")+
theme_bw()+
  theme(panel.grid.minor =element_blank())+
  labs(x="Days Diseased",y="Number of experimental frags")+
  scale_x_continuous(breaks=seq(1,18,1))+
  theme(axis.title.x=element_text(size=12),axis.title.y=element_text(size=12))

initdisplot+daysdisplot
```



## Clustering Analysis

```{r load packages, results='hide',message=FALSE, warning=FALSE}
library(FD)         # gower dissimiliarity matrix and some other 
#clustering stuff
library(ggplot2)    # plotting
library(vegan)      # stats
library(tidyverse)  # data manipulation
#cluster numbers
library(mclust)     # normal mixture modeling for model based clustering,
#customize denddrogram
library(dendextend) 
```



```{r}
e1<-data.frame(cbind(exp1$Geno.std,exp1$Donor.Frag,exp1$Day.14,daysdis(exp1)$disdays,daystodis(exp1)$daystodis,"Experiment 1"))
e2<-data.frame(cbind(exp2$Geno.std,exp2$Donor.Frag,exp2$Day.11,daysdis(exp2)$disdays,daystodis(exp2)$daystodis,"Experiment 2"))
e3<-data.frame(cbind(exp3$Geno.std,exp3$Donor.Frag,exp3$Day.16,daysdis(exp3)$disdays,daystodis(exp3)$daystodis,"Experiment 3"))
e4<-data.frame(cbind(exp4$Geno.std,exp4$Donor.Frag,exp4$Day.18,daysdis(exp4)$disdays,daystodis(exp4)$daystodis,"Experiment 4"))
all.exps<-rbind(e1,e2,e3,e4)
colnames(all.exps)<-c("geno","Donor Colony","result","daysdiseased","daystodisease","experiment")
all.exps$daysdiseased<-as.numeric(all.exps$daysdiseased)
all.exps$daystodisease<-as.numeric(all.exps$daystodisease)
all.exps$geno<-as.factor(all.exps$geno)
all.exps$experiment<-as.factor(all.exps$experiment)
length(levels(all.exps$geno))
write.csv(all.exps,"combinedexperiments.csv")
```
```{r}
all.exps<-read.csv("combinedexperiments.csv")
all.exps
mean(all.exps$daysdiseased,na.rm=TRUE)
sd(all.exps$daysdiseased,na.rm=TRUE)/sqrt(length(all.exps$daysdiseased))

```




```{r}
colnames(e1)<-c("geno","e1.result","e1.daysdiseased","e1.daystodisease","experiment")
e1$geno<-as.factor(e1$geno)
colnames(e2)<-c("geno","e2.result","e2.daysdiseased","e2.daystodisease","experiment")
e2$geno<-as.factor(e2$geno)
m12<-merge(e1[,1:4],e2[,1:4],"geno",all.x=TRUE,all.y=TRUE)

colnames(e3)<-c("geno","e3.result","e3.daysdiseased","e3.daystodisease","experiment")
e3$geno<-as.factor(e3$geno)
colnames(e4)<-c("geno","e4.result","e4.daysdiseased","e4.daystodisease","experiment")
e4$geno<-as.factor(e4$geno)
m34<-merge(e3[,1:4],e4[,1:4],"geno",all.x=TRUE,all.y=TRUE)

allmerge<-merge(m12,m34,by="geno",all.x=TRUE,all.y=TRUE)

allmerge[!duplicated(allmerge),]
```
```{r}
histogram(allexpresults$dis.exp.frac)
ggplot(allexpresults,aes(y=dis.exp.frac*replicates,x=replicates))+ geom_point()
table(allexpresults$replicates,allexpresults$dis.exp.frac)
theme_bw()+
  theme(panel.grid.minor =element_blank())+
  labs(x="Fraction of Exposed that Developed Disease Signs",y="Number of putative genotypes")+
  #scale_x_continuous(breaks=seq(0,1,.3))+
  theme(axis.title.x=element_text(size=14),axis.title.y=element_text(size=14))
```


```{r,fig.width=12,fig.height=6}
allexpresults<-read.csv("allexpresults.csv")
head(allexpresults)
res.sub<-subset(allexpresults,subset=replicates>1)
row.names(res.sub)<-res.sub$geno
res.sub
data_gdis<-gowdis(res.sub[,3:5])
hc_gowdis <- hclust(data_gdis, method = "ward.D2" )
dend <- as.dendrogram(hc_gowdis)
dend
plot(dend)

col_dend <- color_branches(dend, k = 3,col=c("darkblue","lightblue","mediumblue"))
plot(col_dend,xlab="Putative Genotypes",ylab="Clustering Height")
groups<-cutree(hc_gowdis,3)
res.sub$sus.groups<-as.factor(groups)
res.sub[order(res.sub[,14],decreasing=TRUE),]

write.csv(res.sub,"rankinggenos_all_3groups.csv")
```

```{r}
allexpresults[order(allexpresults[,3],decreasing=FALSE),]
```


### Risk Analysis
```{r}
library(epitools)
```

```{r}
r243 <- matrix(c(12,2,7,9), 2, 2)
dimnames(r243) <- list(Diarrhea = c("Yes", "No"),"Antibody level" = c("Low", "High"))
r243
r243b <- t(r243)
r243b
epitab(r243, rev = "b", verbose = TRUE)
epitab(r243, method="riskratio",rev = "b", verbose = TRUE)
```
I don't think that the above is what we want

```{r}

```



```{r}
library(mcmc)
```
From McKnight et al., 2021: relative risk = risk in exposed / risk in non-exposed
where the risk in exposed individuals was calculated as the prevalence (diseased/total population) of those exposed to disease and risk in non-exposed individuals was calculated as the prevalence (diseased/total population) of those not exposed to the disease. 

To obtain an estimate of relative risk, Markov Chain Monte Carlo simulations were used with Gibbs sampling in OpenBUGS (MRC Biostatistics Unit, Cambridge, UK). Ninety-five percent credible intervals were calculated for each estimate of relative risk. Credible intervals that did not include a value of one were considered significant, with a credible interval above one signifying a higher risk of disease because of exposure to the diseased coral fragment. A credible interval below one signified a lower risk of disease from exposure.


```{r}
riskdf<-read.csv("RiskAssessmentData.csv")
head(riskdf)

riskdf$Geno<-as.factor(riskdf$Ã¯..Genotype)
riskdf$State<-as.factor(riskdf$Final)
riskdf$Exp<-as.factor(riskdf$Experiment)
head(riskdf)
riskdf<-riskdf[,4:6]
head(riskdf)
```

```{r}
riskgeno<-as.data.frame.matrix(table(riskdf$Geno,riskdf$State))
riskgeno$Geno<-rownames(riskgeno)
riskgeno$Reps<-riskgeno$Diseased+riskgeno$Healthy
riskgeno
```

