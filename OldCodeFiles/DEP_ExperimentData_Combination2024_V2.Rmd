---
title: "DEP Susceptibility data combination V2024"
output: html_notebook
---
Created 3/22 from previous notebook used to create the DEP Genotypes Metadata V03192024. This notebook will used updated experiment observation data to get a combined genotypes list that matches to wgs IDs. The experiment observation data had to be updated to split the 5 genotype pairs into names instead of putative genotypes (F32/OF32, S509/OF509, 1OF2/OF2/F1A, S483/OF483, S373/OF373). 

```{r}
library(tidyverse)
library(dplyr) 
library(zoo)
library(ggplot2)
library(patchwork)
```
### Data Going In
- Mote restoration genotype metadata: added copied rows for the problem children but will need to add a note in final metadata
- WGS results 3/22/23 
- Experiment status results: each exposed frag with individual ID, putative genotype, genotype name, geno.std which is no spaces or dashes, tank, treatment, donor frag, donor change, and then health state day 0 through 14

### First, combine individual experiment observations and get list of all genotypes exposed
```{r}
exp1<-read.csv("Exp1_statusV032024.csv")
head(exp1)
exp2<-read.csv("Exp2_statusV032024.csv")
head(exp2)
exp3<-read.csv("Exp3_statusV032024.csv")
head(exp3)
exp4<-read.csv("Exp4_statusV032024.csv")
head(exp4)

```
```{r}
allexpgenos<-rbind(exp1[,c(1,3,4)],exp2[,c(1,3,4)],exp3[,c(1,3,4)],exp4[,c(1,3,4)])
allexpgenos
allexpgenos<-subset(allexpgenos,!duplicated(Putative.Genotype.ID))
head(allexpgenos)
```
175 putative genotypes exposed


Combine Genotype Metadata
```{r}
#get datain
Rdata<-read.csv("DEPOFAVGenosRestorationInfoV032024.csv") #more restoration genotypes metadata
head(Rdata)
WGS<-read.csv("WGSresults_V032024.csv") #wgs results
head(WGS)
#add WGS ID
WGS$Multi.Locus.Genotype.ID<-paste("WGS-",WGS$Multi.Locus.Genotype.ID,sep="")
#check
WGS$Geno.std %in% allexpgenos$Geno.std
#merge
expGenosWGS<-full_join(allexpgenos,WGS,by=c("Geno.std"="Geno.std"),keep=TRUE)
#add putative IDs to those WGS missing them
expGenosWGS[is.na(expGenosWGS$Putative.Genotype.ID),"Putative.Genotype.ID"]<-expGenosWGS[is.na(expGenosWGS$Putative.Genotype.ID),"Geno.std.y"]
#make DEP genotype
expGenosWGS$DEP.Genotype<-expGenosWGS$Multi.Locus.Genotype.ID
#for those without WGS assignments, add DEP.Genotype
expGenosWGS[is.na(expGenosWGS$DEP.Genotype),"DEP.Genotype"]<-expGenosWGS[is.na(expGenosWGS$DEP.Genotype),"Genotype"]

#some duplicates, all are fromthe technical replicates,leave in for now.
expGenosWGS[expGenosWGS$Putative.Genotype.ID %in% expGenosWGS[duplicated(expGenosWGS$Putative.Genotype.ID),]$Putative.Genotype.ID,]
```
188 observations

So this dataset will not have any putative genotype info for those not exposed

Add in Restoration info
```{r}
WGSrestorationInfo<-full_join(expGenosWGS,Rdata,by=c("Putative.Genotype.ID"="Putative.Genotype.ID"))

WGSMoteRestoration<-subset(WGSrestorationInfo,subset=!is.na(DEP.Genotype))
colnames(WGSMoteRestoration)
WGSMoteRestoration<-WGSMoteRestoration[,c(18:22,1:3,23:30,4:5,7:17,31:38)]
write.csv(WGSMoteRestoration,"WGSMetadataV032024.csv")



#get just the names and delete duplicates (tech reps)
notechreps<-WGSMoteRestoration[!duplicated(WGSMoteRestoration$Putative.Genotype.ID),]

GenoMetaShort<-notechreps[,c(1:8)]
GenoMetaShort[duplicated(GenoMetaShort$Putative.Genotype.ID),]

```

##Now add in experiment results

### Days to infection and days diseased
#### Functions
```{r}

new_inf_corals<-function(df,steps,x){
  ## newly_I
  newly_I<-matrix(NA, nrow = (nrow(df)), ncol = steps+1) #blank matrix for storing newly infected corals
  #newly_I
  for (i in 1:steps){ #for each survey time point
    col<-x+i #start with first tp after init tp
    prev<-x+i-1
    for (j in 1:(nrow(df))){ #for each row in the df
      #print (df[j,col])
      if ( df[j,col]=="Diseased" ){ #if it's diseased
        #print( "found one")
        if (df[j,prev]!="Diseased"){ # and if it wasnt diseased before
          newly_I[j,i]<-1 #add it to newly infected
        }
      }
    }
  }
  return(newly_I)
}

daystodis<-function(exp.df){
  exp.copy<-exp.df
  exp.copy[exp.df=="Initial Disease"]<-"Diseased"
  lastcall<-ncol(exp.copy)-9+1
  wheninf<-new_inf_corals(exp.copy,ncol(exp.copy)-9,9)
  
  wheninf[,lastcall]<-.5
  exp.df$daystodis<-apply(wheninf,1,which.max)
  for(i in 1:nrow(exp.df)){
    if(exp.df$daystodis[i]==lastcall){
      exp.df$daystodis[i]<-NA
    }
  }
  return(exp.df)
}

dis_corals<-function(df,steps,x){
  ## newly_I
  dismat<-matrix(0, nrow = nrow(df), ncol = steps) #blank matrix for storing newly infected corals
  #newly_I
  for (i in 1:steps){ #for each survey time point
    col<-x+i #start with first tp after init tp
    prev<-x+i-1
    for (j in 1:(nrow(df))){ #for each row in the df
      #print (df[j,col])
      if ( df[j,col]=="Diseased" ){ #if it's diseased
        #print( "found one")
        dismat[j,i]<-1
      }
    }
  }
  
  return(dismat)
}


daysdis<-function(exp.df){
  exp.copy<-exp.df
  exp.copy[exp.df=="Initial Disease"]<-"Diseased"
  whendis<-dis_corals(exp.copy,ncol(exp.copy)-9,9)
  df<-data.frame(exp.df[,1:4],disdays=rowSums(whendis))
  for(i in 1:nrow(exp.copy)){
    if(exp.copy[i,ncol(exp.copy)]=="Healthy"){
      df$disdays[i]<-NA
    }
  }
  return(df)
}

```



```{r}
e1<-data.frame(cbind(exp1[,c(1:8,ncol(exp1))],daysdis(exp1)$disdays,daystodis(exp1)$daystodis,"Experiment 1"))
e2<-data.frame(cbind(exp2[,c(1:8,ncol(exp2))],daysdis(exp2)$disdays,daystodis(exp2)$daystodis,"Experiment 2"))
e3<-data.frame(cbind(exp3[,c(1:8,ncol(exp3))],daysdis(exp3)$disdays,daystodis(exp3)$daystodis,"Experiment 3"))
e4<-data.frame(cbind(exp4[,c(1:8,ncol(exp4))],daysdis(exp4)$disdays,daystodis(exp4)$daystodis,"Experiment 4"))
colnames(e1)<-c(colnames(exp1[,1:8]),"Result","Daysdiseased","Daystodisease","Experiment")
colnames(e2)<-c(colnames(exp2[,1:8]),"Result","Daysdiseased","Daystodisease","Experiment")
colnames(e3)<-c(colnames(exp3[,1:8]),"Result","Daysdiseased","Daystodisease","Experiment")
colnames(e4)<-c(colnames(exp4[,1:8]),"Result","Daysdiseased","Daystodisease","Experiment")
#combine into 1
all.exps<-rbind(e1,e2,e3,e4)
all.exps$Daysdiseased<-as.numeric(all.exps$Daysdiseased)
all.exps$Daystodisease<-as.numeric(all.exps$Daystodisease)
length(levels(as.factor(all.exps$Putative.Genotype.ID)))
#checks
all.exps$Putative.Genotype.ID %in% GenoMetaShort$Putative.Genotype.ID
duplicated(all.exps$Individual.ID)
#merge
allEXPS<-right_join(GenoMetaShort,all.exps,by=c("Putative.Genotype.ID"="Putative.Genotype.ID"))

allEXPS$DEP.Genotype
length(levels(as.factor(allEXPS$DEP.Genotype)))
duplicated(allEXPS$Individual.ID)
colnames(allEXPS)
nrow(allEXPS)
write.csv(allEXPS,"CombinedExperimentsIndividuals_V032024.csv")
```
add in numbers exposed, removed, healthy
```{r}
alldf<-allEXPS

#first need a binary result: 1 diseased/removed at end, 0 if healthy
for (i in 1:nrow(alldf)){
  if(alldf$Result[i]=="Healthy"){
    alldf$ResultBinary[i]<-0
  }else(alldf$ResultBinary[i]<-1)
}

alldf$ResultBinary<-as.numeric(alldf$ResultBinary)
numremoveddf<-aggregate(ResultBinary~DEP.Genotype,data=alldf,FUN=sum)
numexposeddf<-aggregate(Result~DEP.Genotype,data=alldf,FUN=length)

DEPsummary<-cbind(numexposeddf,numremoveddf$ResultBinary)
colnames(DEPsummary)<-c("DEP.Genotype","Num.Exposed","Num.Removed")
DEPsummary$Num.healthy<-DEPsummary$Num.Exposed-DEPsummary$Num.Removed
summary(DEPsummary)

allbyDEP<-right_join(DEPsummary,alldf,by=c("DEP.Genotype"="DEP.Genotype"))
allbyDEP[allbyDEP$Result=="Diseased",]$Result<-"Removed"
write.csv(allbyDEP,"CombinedExperimentsIndividualsWithExposedNumberByDEPGENO_V032024.csv")

```

Get the data into long format and get the timepoints into the right format 
```{r}
#move to a long format so that every row is now an observation of a colony at a single timepoint
e1_long <- gather(exp1, key=timept, value=state, Day.0:Day.14,factor_key = TRUE)
head(e1_long)
#make the health states factors
summary(e1_long)
e1_long$state<-factor(e1_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e2_long <- gather(exp2, key=timept, value=state, Day.0:Day.11,factor_key = TRUE)
head(e2_long)
#make the health states factors
e2_long$state<-factor(e2_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

#move to a long format so that every row is now an observation of a colony at a single timepoint
e3_long <- gather(exp3, key=timept, value=state, Day.0:Day.16,factor_key = TRUE)

#make the health states factors
e3_long$state<-factor(e3_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

head(e3_long)
levels(e3_long$state)

#move to a long format so that every row is now an observation of a colony at a single timepoint
e4_long <- gather(exp4, key=timept, value=state, Day.0:Day.18,factor_key = TRUE)
head(e4_long)
#make the health states factors
e4_long$state<-factor(e4_long$state,levels=c("Healthy","Watch","Initial Disease","Diseased", "Removed"))

```

```{r}
e1_long$Experiment<-"Exp1"
e2_long$Experiment<-"Exp2"
e3_long$Experiment<-"Exp3"
e4_long$Experiment<-"Exp4"
allexplong<-rbind(e1_long,e2_long,e3_long,e4_long)

IndExpStates<-right_join(GenoMetaShort,allexplong,by=c("Putative.Genotype.ID"="Putative.Genotype.ID"))

write.csv(IndExpStates,"IndividualStates_V032024.csv")
```



