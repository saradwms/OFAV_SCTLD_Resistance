---
title: "Ex Situ Massives Outplants"
output: html_notebook
---

R version 4.1.1 (2021-08-10) 

Initial look at ex situ massives data to subset out the ofav for DEP analysis.

```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(readr)
library(lubridate)
library(patchwork)
```

```{r}
ofav<-read_csv("JustOFAV.csv")
ofav$Outplant.Date<-ymd(ofav$Outplant.Date)
ofav$Monitoring.Date<-ymd(ofav$Monitoring.Date)
ofav$Geno<-as.factor(ofav$Geno)
summary(ofav)
```


```{r}
DEPmeta<-read.csv("WGSresults_MoteRestoration_Metadata_V03192024.csv")
colnames(DEPmeta)
DEPmeta<-subset(DEPmeta,subset=Known.Mote.geno=="Y")
#DEPmeta<-subset(DEPmeta,subset=Sample.Source=="Experiment")
DEPmeta$Restoration.name<-as.factor(DEPmeta$Restoration.name)

ofav1819<-subset(ofav,subset=Outplant.Date<="2020-01-01")
#ofav<-ofav1819
levels(ofav$Geno) %in% levels(DEPmeta$Restoration.name)
meta<-DEPmeta[,c("Restoration.name","Multi.Locus.Genotype.ID")]
meta<-distinct(meta)

ofav2<-subset(ofav,subset=Geno %in%meta$Restoration.name)

```


```{r,fig.width=8}
ofmeans<-aggregate(Perc.Survival~Geno*Time.Point,data=ofav2,FUN=mean)
ofse<-aggregate(Perc.Survival~Geno*Time.Point,data=ofav2,FUN=function(x) sd(x)/sqrt(length(x)))
OFAV<-cbind(ofmeans,ofse$Perc.Survival)
colnames(OFAV)<-c("Geno","Time.Point","means","se")

ofav3<-left_join(OFAV,meta,by=c("Geno"="Restoration.name"))

moremeta<-read.csv("DEPsusgroups.csv")
moremeta
OFAV1<-left_join(ofav3,moremeta,by=c("Multi.Locus.Genotype.ID"="DEP.Genotype"))
OFAV1$Geno.name<-paste(OFAV1$Geno,OFAV1$Multi.Locus.Genotype.ID,sep="/")

OFAV1$Sus.group<-factor(OFAV1$Sus.group,levels=c("Highly Susceptible","Susceptible", "Intermediate","Resistant","1/1 Resistant"))

```


```{r,fig.width=8}
OFAV1<-OFAV1[OFAV1$Geno!="OF689",]
OFAV1s<-subset(OFAV1,subset=Time.Point=="One.Year")

ggplot(OFAV1s,aes(x=Geno.name,y=means,fill=Sus.group))+
  geom_bar(stat="identity",position=position_dodge(.9))+
  geom_errorbar(aes(ymax=means + se, ymin=means-se),width=0.2,position=position_dodge(.9))+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"), drop = FALSE)+
  #scale_x_discrete(limits=levels(bills.spsex$sps))+
  scale_y_continuous(breaks=seq(0,100,10),expand = c(0, 0),lim=c(0,110))+
  labs(x="",y="Percent Survival at One Year")+
  theme(legend.position ="bottom", legend.text=element_text(size=12), legend.title=element_blank()) + #extra to make it pretty
  theme(panel.background = element_blank())+
  #theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_text(angle=45,hjust=1))
 # facet_wrap(~Location,scales="free_x",nrow=2)
ggsave("DEPgenoOutplantSurvivalOneYear_V021225.jpg")

```

```{r}
ofmeans<-aggregate(means~Sus.group,data=OFAV1s,FUN=mean)
ofse<-aggregate(means~Sus.group,data=OFAV1s,FUN=function(x) sd(x)/sqrt(length(x)))
OFAV<-cbind(ofmeans,ofse$means)
colnames(OFAV)<-c("Geno","means","se")

ggplot(OFAV,aes(x=Geno,y=means,fill=Geno))+
  geom_bar(stat="identity",position=position_dodge(.9))+
  geom_errorbar(aes(ymax=means + se, ymin=means-se),width=0.2,position=position_dodge(.9))+
  scale_fill_manual(values=c("red3","orange1","steelblue3","springgreen4","palegreen2"), drop = FALSE)+
  #scale_x_discrete(limits=levels(bills.spsex$sps))+
  scale_y_continuous(breaks=seq(0,100,10),expand = c(0, 0),lim=c(0,110))+
  labs(x="",y="Percent Survival at One Year")+
  theme(legend.position ="bottom", legend.text=element_text(size=12), legend.title=element_blank()) + #extra to make it pretty
  theme(panel.background = element_blank())+
  #theme(text = element_text(family = "Times New Roman"))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),axis.text.x=element_text(angle=45,hjust=1))
  #facet_wrap(~Location,scales="free_x",nrow=2)
ggsave("DEPSusgroupOutplantSurvivalOneYear_V021225.jpg")
```


```{r}
min(ofav$Outplant.Date)
max(ofav$Outplant.Date)
length(levels(ofav3$Geno))
```

ofav3<-left_join(ofav2,meta,by=c("Geno"="Restoration.name"))

moremeta<-read.csv("DEPsusgroups.csv")
moremeta
OFAV1<-left_join(ofav3,moremeta,by=c("Multi.Locus.Genotype.ID"="DEP.Genotype"))
OFAV1$Geno.name<-paste(OFAV1$Geno,OFAV1$Multi.Locus.Genotype.ID,sep="/")
OFAV1<-OFAV1[OFAV1$Geno!="OF689",]
write.csv(OFAV1,"OFAVDEPsusgroupssaved.csv")


